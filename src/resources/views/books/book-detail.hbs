<div class="container">


  <h1>{{title}}</h1>
  <p>Web bán truyện được ưa thích nhất</p>
  <div class="book-information">

    <div class="row">
      <div class="col-lg-3">
        <img src="{{book.HINHANH}}" />
      </div>
      <div class="col-lg-6">
        <h3>{{book.tensach}}</h3>
        <div style="display: flex; margin:0%">
          <p>Tác giả: </p>
          <p style="color: #F4A02E; margin-left:3px;">{{book.tacgia}}</p>
        </div>
        <div style="display: flex; margin:0%">
          <p>Dịch giả: </p>
          <p style="color: #F4A02E; margin-left:3px;">NoName</p>
        </div>
        <p style="color:#F4622D; font-size:30px; font-weight:bold">{{book.gia}}đ</p>
        <div style="display: flex; margin:0%">
          <p>Số lượng: </p>
          <p style="color: #F4A02E; margin-left:3px;">{{book.SL}}</p>
        </div>
        <form action="/shopping-cart" method="POST" id="addCart">
        <div style="width: 150px;margin-bottom:5px">
          <div class="input-group">
            <span class="input-group-btn">
              <button type="button" class="btn btn-warning" data-type="minus" data-field="">
                <span>-</span>
              </button>
            </span>
            <input type="text" id="quantity" name="quantity" class="form-control input-number" value="1" min="0"
              max="100"  />
            <span>
              <button type="button" class="btn btn-warning" data-type="plus" data-field="">
                <span class="glyphicon glyphicon-plus">+</span>
              </button>
            </span>
          </div>
        </div>
        <div>
          
          <input type="hidden" name="bookid" value="{{book.masach}}">
          <input type="hidden" name="bookIMG" value="{{book.HINHANH}}">
          <input type="hidden" name="bookName" value="{{book.tensach}}">
          <input type="hidden" name="bookPrice" value="{{book.gia}}">
          <button type="button" name="add-to-cart" class="btn btn-primary"  id="add-to-cart">Thêm vào giỏ hàng</button>
          <button type="button" class="btn btn-warning">Đặt ngay</button>
          
        </div>
        </form>
        <div style="display:flex">
          <p>Gọi đặt hàng: </p>
          <p style="color:#F46247;margin-left:5px">(0xx) xxxx xxxx</p>
        </div>
        <div>
          <h4>
          Thông tin khuyến mãi
        </h4>
        <p style = "margin: 5px;">Đổi trả trong vòng 7 ngày</p>
        <p style = "margin: 5px;">Giao hàng tận nơi</p>
        </div>

      </div>

      <div class="col-lg-3">
        <div class="book-information" style="background:white">
          <span style="display:flex;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-bookmark-heart" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M8 4.41c1.387-1.425 4.854 1.07 0 4.277C3.146 5.48 6.613 2.986 8 4.412z">
              </path>
              <path
                d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z">
              </path>
            </svg>
            <p style="color:#1E9BF0;">Sản phẩm được ưa thích</p>
          </span>
          <span style="display:flex;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-truck"
              viewBox="0 0 16 16">
              <path
                d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z">
              </path>
            </svg>
            <p style="color:#1E9BF0;">Freeship toàn quốc</p>
          </span>
        </div>
      </div>
    </div>

  </div>
  <!-- Modal -->
<div class="modal fade" id="outOfStockModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel">Thông báo</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="messageModal"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closeModal">Close</button>
        
      </div>
    </div>
  </div>
</div>

  {{!-- <div class="book-information">
    <div class="row">
      <h2>Thông tin chi tiết</h2>
      <div class="col-2">
        <p>Nhà xuất bản: {{book.}}</p>
      </div>
      <div class="col-10">
        <p><a href="#">NXB Kim Đồng</a></p>
      </div>
      <div class="col-2">
        <p>Ngày xuất bản</p>
      </div>
      <div class="col-10">
        <p>11/11/2021</p>
      </div>
      <div class="col-2">
        <p>Nhà phát hành</p>
      </div>
      <div class="col-10">
        <p><a href="#">NoName</a></p>
      </div>
      <div class="col-2">
        <p>Kích thước</p>
      </div>
      <div class="col-10">
        <p>15.0 x 25.0 x 1.5 cm</p>
      </div>
      <div class="col-2">
        <p>Số trang</p>
      </div>
      <div class="col-10">
        <p>416 trang</p>
      </div>
      <div class="col-2">
        <p>Trọng lượng</p>
      </div>
      <div class="col-10">
        <p>460 gram</p>
      </div>
    </div>
  </div> --}}

  <div class="book-information">
    <div class="row">
      <h2>Giới thiệu sách</h2>
      <h3 style="text-align:center; color:#F46247">{{book.tensach}}</h3>
      <p>{{book.MOTA}}</p>
    </div>
  </div>

  <div class="book-information">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  
  <section class="content-item" id="comments">
    <div class="container">   
    	<div class="row justify-content-md-center" >
            <div class="col-sm-8">   
              {{#if user}}
                <form>
                	<h3 class="pull-left">New Comment : {{user.HOTEN}}</h3>
                	<button type="submit" id="submit-comment" class="btn btn-normal pull-right">Submit</button>
                    <fieldset>
                        <div class="row">
                            <div class="col-sm-3 col-lg-2 hidden-xs">
                            	<img class="img-responsive" src="{{user.HINHANH}}" alt="">
                            </div>
                            <div class="form-group col-xs-12 col-sm-9 col-lg-10">
                                <textarea class="form-control" id="message" placeholder="Your message" required=""></textarea>
                            </div>
                        </div>  	
                    </fieldset>
                </form>
                {{else}}
                <div class="container">
                  <div class="row justify-content-md-center text-center">
                    <div> Đăng nhập để bình luận </div>
                    <a href="/login" class="btn btn-primary col-4">Đăng nhập</a>
                  </div>
                </div>
              {{/if}}
                <h3 class="quantity-cmt"></h3>
                <div id="comment-show">


                </div>
                <!-- COMMENT 1 - START -->
                <!-- <div class="media">
                    <a class="pull-left" href="#"><img class="media-object" src="{{user.HINHANH}}" alt=""></a>
                    <div class="media-body">
                        <h4 class="media-heading">John Doe</h4>
                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                        <ul class="list-unstyled list-inline media-detail pull-left">
                            <li><i class="fa fa-calendar"></i>27/02/2014</li>
                        </ul>
                    </div>
                </div> -->
                <!-- COMMENT 1 - END -->
                
                
            
            </div>
        </div>
        <div class="d-flex justify-content-center" >
      <nav aria-label="Page navigation example">
        <ul class="pagination" id="pagination">
          <li class="page-item"><a class="page-link" href="#">1</a></li>
          {{!-- <li class="page-item"><a class="page-link" href="#" value="-1">Previous</a></li>
          
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item"><a class="page-link" href="#">Next</a></li> --}}
        </ul>
      </nav>
    </div>
    </div>
  </section>
  
  </div>
</div>

<script>
function generatePaginateComment(ttPage,crPage)  
{
  var pagi= document.getElementById("pagination");
  pagi.innerHTML="\n";
  for (let i=0;i<ttPage;i++)
  {
    var className="page-item";
    if(i+1==crPage)
    {
      className+=" active";
    }
    var liDiv=`<li class="${className}"><a class="page-link" href="#comment-show" onclick="onPageChanged(${i+1})">${i+1}</a></li>\n`;
    pagi.innerHTML+=liDiv;

  }
}  

  
</script>

<script>


  var bookid = '{{book.masach}}'
  $('#submit-comment').on('click', function(e) {
    e.preventDefault();
    var text = $('#message').val()
    var user = '{{user.USER}}'
    console.log(bookid + ": " + user)

    if(text != ''){
      $.ajax({
        url:`/books/${bookid}/comment`,
        method: "POST",
        data:{
          NOIDUNG: text,
          USER: user
        },success: function(data) {
          console.log('success')
          loadFunction()
        }

      })
      $('#message').val('');
    }else{
      alert('Hãy viết comment')
    }
  })
 
  const MAX_CMT_ON_PAGE=5;
  var currentPage=1;
  function onPageChanged(newPage)
  {
    currentPage=newPage;
    loadFunction();
  }
  function loadFunction(){
    
    $.getJSON(`${bookid}/comment`, function(data) {
      $('h3.quantity-cmt').empty();
      $('h3.quantity-cmt').append(data.cmt.length+' Comments')
      let html = ''
      const l=data.cmt.length;
      const totalPage=Math.ceil(l/MAX_CMT_ON_PAGE);
      generatePaginateComment(totalPage,currentPage);
      const begin=(currentPage-1)*MAX_CMT_ON_PAGE;
      const end=((currentPage)*MAX_CMT_ON_PAGE-1)>(l-1)?(l-1):((currentPage)*MAX_CMT_ON_PAGE-1);
      console.log(begin);
      console.log(end);
      for (let i=begin;i<=end;i++){
        const key=data.cmt[i];
        html+= `<div class="media">
                    <a class="pull-left" href="#"><img class="media-object" src="${key.HINHANH}" alt="${key.HOTEN}"></a>
                    <div class="media-body">
                        <h4 class="media-heading">${key.HOTEN}</h4>
                        <p>${key.NOIDUNG}</p>
                        <ul class="list-unstyled list-inline media-detail pull-left">
                            <li><i class="fa fa-calendar"></i>${key.THOIGIAN}</li>
                        </ul>
                    </div>
                </div>`
      }
      $('#comment-show').html(html)
    })


  }
  loadFunction()

  const cartForm=$('#addCart')[0];
  const cartButton=$('#add-to-cart')[0];
  const oosModal=$('#outOfStockModal');
  $('closeModal').onclick=function(e){
    oosModal.modal('hide');
  }
  cartButton.onclick= function(e){
    if({{book.SL}}!=0)
    {
      if(parseInt($('#quantity')[0].value)>={{book.SL}})
      {
        $('#messageModal').html("Số lượng muốn đặt không hợp lệ") ;     
        oosModal.modal('show');
        oosModal.focus();  
        return;
      }
      
      cartForm.submit();
    }
    else
    {
      //check  out of stock
    $('#messageModal').html("Hiện tại sách này đã hết hàng. Quý khách vui lòng thử lại sau." ); 
      
    oosModal.modal('show');
    oosModal.focus();  
    }
    
    e.preventDefault();
  }
  
</script>